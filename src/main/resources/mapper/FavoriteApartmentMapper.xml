<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jipjung.project.repository.FavoriteApartmentMapper">

    <!-- Result Map -->
    <resultMap id="FavoriteApartmentResultMap" type="com.jipjung.project.domain.FavoriteApartment">
        <id property="id" column="favorite_id"/>
        <result property="userId" column="user_id"/>
        <result property="aptSeq" column="apt_seq"/>
        <result property="createdAt" column="favorite_created_at"/>
        <association property="apartment" javaType="com.jipjung.project.domain.Apartment">
            <id property="aptSeq" column="apt_seq"/>
            <result property="aptNm" column="apt_nm"/>
            <result property="umdNm" column="umd_nm"/>
            <result property="roadNm" column="road_nm"/>
            <result property="buildYear" column="build_year"/>
            <result property="latitude" column="latitude"/>
            <result property="longitude" column="longitude"/>
        </association>
    </resultMap>

    <!-- 관심 아파트 등록 -->
    <insert id="insert" parameterType="com.jipjung.project.domain.FavoriteApartment"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO favorite_apartment (user_id, apt_seq)
        VALUES (#{userId}, #{aptSeq})
    </insert>

    <!-- 사용자별 관심 아파트 목록 조회 (아파트 정보 포함) -->
    <select id="findByUserId" resultMap="FavoriteApartmentResultMap">
        SELECT f.favorite_id,
               f.user_id,
               f.apt_seq,
               f.created_at as favorite_created_at,
               a.apt_nm,
               a.umd_nm,
               a.road_nm,
               a.build_year,
               a.latitude,
               a.longitude
        FROM favorite_apartment f
        INNER JOIN apartment a ON f.apt_seq = a.apt_seq
        WHERE f.user_id = #{userId}
        ORDER BY f.created_at DESC
    </select>

    <!-- 관심 아파트 상세 조회 -->
    <select id="findById" resultMap="FavoriteApartmentResultMap">
        SELECT f.favorite_id,
               f.user_id,
               f.apt_seq,
               f.created_at as favorite_created_at,
               a.apt_nm,
               a.umd_nm,
               a.road_nm,
               a.build_year,
               a.latitude,
               a.longitude
        FROM favorite_apartment f
        INNER JOIN apartment a ON f.apt_seq = a.apt_seq
        WHERE f.favorite_id = #{id}
    </select>

    <!-- 관심 아파트 삭제 -->
    <delete id="deleteById">
        DELETE FROM favorite_apartment
        WHERE favorite_id = #{id}
    </delete>

    <!-- 중복 체크 -->
    <select id="existsByUserIdAndAptSeq" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM favorite_apartment
        WHERE user_id = #{userId} AND apt_seq = #{aptSeq}
    </select>

</mapper>
